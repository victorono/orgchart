class SimpleOrgChart{constructor(t){if(!t.container)throw Error("A container must be specified");if(!t.data)throw Error("Data is required to generate the chart");if(this.container=document.getElementById(t.container),!this.container)throw Error(`Container with ID '${t.container}' not found`);let e={nodeWidth:180,nodeHeight:140,horizontalSpacing:60,verticalSpacing:80,avatarSize:60,nodeColor:"#4ade80",lineColor:"#4ade80",textColor:"#000000",subtitleColor:"#6b7280",initiallyExpanded:!1,initialVisibleLevels:1};this.options={...e,...t.options||{}},this.data=t.data,this.hierarchicalData=null,this.svg=null,this.expandedNodes=new Map,this.svgWidth=800,this.svgHeight=600,this.initialize()}initialize(){this.processData(),this.calculateDimensions(),this.render()}processData(){let t=this.data.tree||this.data,e=[],i=new Set;for(let s of t)i.has(s.id)||(i.add(s.id),e.push(s));let n=new Map;e.forEach(t=>{let e={...t,children:[],level:0};n.set(t.id,e)});let o=[];e.forEach(t=>{let e=n.get(t.id);if(t.pid&&n.has(t.pid)){let i=n.get(t.pid);e.level=i.level+1,i.children.push(e)}else e.level=0,o.push(e)}),this.removeDuplicates(o),this.hierarchicalData=o,this.configureInitialExpansion()}configureInitialExpansion(){let t=(e,i)=>{e.forEach(e=>{let s=this.options.initiallyExpanded&&i<this.options.initialVisibleLevels;this.expandedNodes.set(e.id,s),e.children&&e.children.length>0&&t(e.children,i+1)})};t(this.hierarchicalData,0)}removeDuplicates(t){let e=new Set,i=t=>{let s=[];for(let n of t){let o=n.id.toString();!e.has(o)&&(e.add(o),s.push(n),n.children&&n.children.length>0&&(n.children=i(n.children)))}return s},s=i(t);t.length=0,t.push(...s)}calculateDimensions(){let t=0,e=(i,s)=>{t=Math.max(t,s),i.children&&i.children.length>0&&this.expandedNodes.get(i.id)&&i.children.forEach(t=>e(t,s+1))};this.hierarchicalData.forEach(t=>e(t,1)),this.nodesAtLevel=[],this.nodePositions={};let i=[],s=(t,e)=>{i[e]||(i[e]=0),i[e]++,t.children&&t.children.length>0&&this.expandedNodes.get(t.id)&&t.children.forEach(t=>s(t,e+1))};this.hierarchicalData.forEach(t=>s(t,0));let n=i.map((t,e)=>{let i=t*(this.options.nodeWidth+this.options.horizontalSpacing);return t>5&&(i+=2*this.options.horizontalSpacing),i}),o=Math.max(...n,this.hierarchicalData.length*(this.options.nodeWidth+this.options.horizontalSpacing)*2,800)+2*this.options.horizontalSpacing;this.svgWidth=o;let a=(t,e)=>{let i={nodes:[],totalWidth:0};if(!t||0===t.length)return i;for(let s of t){let n=this.options.nodeWidth,o={node:s,children:[],width:n,level:e,posX:0};if(s.children&&s.children.length>0&&this.expandedNodes.get(s.id)){let r=a(s.children,e+1);o.children=r.nodes;let l=Math.max(n,r.totalWidth);o.width=l,s.children.length>3&&(o.width+=.5*this.options.horizontalSpacing)}i.nodes.push(o),i.totalWidth+=o.width+this.options.horizontalSpacing}return i.totalWidth>0&&(i.totalWidth-=this.options.horizontalSpacing),i},r=a(this.hierarchicalData,0);this.assignXPositions(r.nodes,this.options.horizontalSpacing,0);for(let l=0;l<this.nodesAtLevel.length;l++){let h=this.nodesAtLevel[l]||[];if(!(h.length<=1)){h.sort((t,e)=>this.nodePositions[t.id].x-this.nodePositions[e.id].x);for(let d=1;d<h.length;d++){let c=h[d],p=h[d-1],g=this.nodePositions[c.id].x-this.nodePositions[p.id].x;if(g<this.options.nodeWidth+this.options.horizontalSpacing){let u=this.options.nodeWidth+this.options.horizontalSpacing-g;for(let $=d;$<h.length;$++)this.nodePositions[h[$].id].x+=u,this.adjustSubtreePositions(h[$],u)}}}}let v=0;Object.values(this.nodePositions).forEach(t=>{v=Math.max(v,t.x+this.options.nodeWidth/2)}),this.svgWidth=Math.max(v+this.options.horizontalSpacing,800),this.svgHeight=Math.max(t*(this.options.nodeHeight+this.options.verticalSpacing),600),this.adjustSVGSize()}adjustSVGSize(){let t=1/0,e=-1/0,i=0;Object.values(this.nodePositions).forEach(s=>{t=Math.min(t,s.x-this.options.nodeWidth/2),e=Math.max(e,s.x+this.options.nodeWidth/2),i=Math.max(i,s.level)}),(t===1/0||e===-1/0)&&(t=0,e=800);let s=2*this.options.horizontalSpacing,n=e-t+s,o=(i+1)*(this.options.nodeHeight+this.options.verticalSpacing)+100;this.svgWidth=Math.max(n,800),this.svgHeight=Math.max(o,600),this.svg&&this.svg.setAttribute("viewBox",`0 0 ${this.svgWidth} ${this.svgHeight}`)}toggleNode(t){let e=this.expandedNodes.get(t),i=this.currentScale,s=this.translationX,n=this.translationY,o=this.nodePositions[t],a=o?o.x:null,r=o?o.level:null;if(this.mapCurrentConnections(),this.expandedNodes.set(t,!e),!e){let l=this.findNodeById(t);l&&l.children&&l.children.length>0&&l.children.forEach(t=>{this.expandedNodes.has(t.id)||this.expandedNodes.set(t.id,!1)})}if(this.nodesAtLevel=[],this.nodePositions={},this.calculateDimensions(),this.render(),null!==a&&null!==r){let h=this.nodePositions[t];if(h){let d=h.x-a;this.translationX=s-d*i}else this.translationX=s}else this.translationX=s;this.translationY=n,this.currentScale=i,this.zoomSlider.value=i,this.zoomLabel.textContent=`${Math.round(100*i)}%`,this.updateTransformation()}mapCurrentConnections(){let t=new Map,e=(i,s=null)=>{s&&(t.has(s.id)||t.set(s.id,[]),t.get(s.id).push(i.id)),i.children&&i.children.length>0&&this.expandedNodes.get(i.id)&&i.children.forEach(t=>e(t,i))};return this.hierarchicalData.forEach(t=>e(t)),t}render(){this.container.innerHTML="",this.createZoomControls(),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("xmlns","http://www.w3.org/2000/svg"),this.svg.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%"),this.svg.setAttribute("viewBox",`0 0 ${this.svgWidth} ${this.svgHeight}`),this.svg.setAttribute("class","organigrama"),this.draggableGroup=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svg.appendChild(this.draggableGroup);let t=document.createElementNS("http://www.w3.org/2000/svg","style");t.textContent=`
        .nodo-organigrama text.nombre {
          font-weight: bold;
          font-size: 14px;
          text-anchor: middle;
          fill: ${this.options.textColor};
        }
        .nodo-organigrama text.cargo {
          font-size: 12px;
          text-anchor: middle;
          fill: ${this.options.subtitleColor};
        }
        .nodo-organigrama circle.avatar {
          fill: ${this.options.nodeColor};
        }
        .nodo-organigrama circle.borde-avatar {
          fill: none;
          stroke: ${this.options.nodeColor};
          stroke-width: 2;
        }
        .linea-conexion {
          stroke: ${this.options.lineColor};
          stroke-width: 2;
          fill: none;
        }
        .boton-expandir-colapsar {
          cursor: pointer;
        }
        .boton-expandir-colapsar:hover circle.circulo-boton {
          stroke-width: 2;
        }
        .boton-expandir-colapsar:hover text.simbolo-boton {
          font-weight: bolder;
        }
        .circulo-boton {
          fill: white;
          stroke: ${this.options.lineColor};
          stroke-width: 1;
        }
        .simbolo-boton {
          fill: ${this.options.lineColor};
          font-weight: bold;
          text-anchor: middle;
          dominant-baseline: central;
          pointer-events: none;
        }
        .nodo-organigrama[data-tiene-hijos="true"] {
          cursor: pointer;
        }
        .nodo-organigrama[data-tiene-hijos="true"]:hover circle.avatar {
          fill-opacity: 0.8;
        }
        .nodo-organigrama[data-tiene-hijos="true"]:hover circle.borde-avatar {
          stroke-width: 3;
        }
        .organigrama {
          cursor: grab;
        }
        .organigrama.arrastrando {
          cursor: grabbing;
        }
        .controles-zoom {
          position: absolute;
          bottom: 20px;
          right: 20px;
          background: white;
          border: 1px solid #ddd;
          border-radius: 4px;
          padding: 5px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          display: flex;
          align-items: center;
          z-index: 1000;
        }
        .controles-zoom button {
          background: #f5f5f5;
          border: 1px solid #ddd;
          border-radius: 4px;
          width: 30px;
          height: 30px;
          font-size: 18px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 5px;
        }
        .controles-zoom button:hover {
          background: #e9e9e9;
        }
        .controles-zoom input[type="range"] {
          width: 100px;
          margin: 0 10px;
        }
        .controles-zoom .zoom-valor {
          width: 40px;
          text-align: center;
          font-size: 12px;
        }
      `,this.svg.appendChild(t),this.container.appendChild(this.svg),this.configureDrag(),this.renderChart(),this.currentScale=1,this.centerChart(),this.updateTransformation()}centerChart(){let t=this.container.getBoundingClientRect(),e=t.width/2;if(t.height,1===this.hierarchicalData.length){let i=this.hierarchicalData[0].id,s=this.nodePositions[i];if(s){let n=s.x;this.translationX=e-n,this.translationY=.25*t.height-50}else this.centerOnSVG()}else this.translationX=(t.width-this.svgWidth*this.currentScale)/2,this.translationY=.25*t.height-50;this.translationY<0&&(this.translationY=20)}centerOnSVG(){let t=this.container.getBoundingClientRect();this.translationX=(t.width-this.svgWidth*this.currentScale)/2,this.translationY=.25*t.height-50,this.translationY<0&&(this.translationY=20)}resetView(){this.currentScale=1,this.centerChart(),this.zoomSlider.value=1,this.zoomLabel.textContent="100%",this.updateTransformation()}createZoomControls(){let t=document.createElement("div");t.className="controles-zoom",t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="center";let e=document.createElement("button");e.innerHTML="−",e.title="Reduce",e.addEventListener("click",()=>this.adjustZoom(-.1));let i=document.createElement("input");i.type="range",i.min="0.5",i.max="3",i.step="0.1",i.value="1",i.style.margin="0 8px",i.addEventListener("input",t=>this.setZoom(parseFloat(t.target.value)));let s=document.createElement("span");s.className="zoom-valor",s.textContent="100%",s.style.minWidth="40px",s.style.textAlign="center",this.zoomLabel=s;let n=document.createElement("button");n.innerHTML="+",n.title="Enlarge",n.addEventListener("click",()=>this.adjustZoom(.1));let o=document.createElement("button");o.innerHTML="↺",o.title="Reset view",o.addEventListener("click",()=>this.resetView()),t.appendChild(e),t.appendChild(i),t.appendChild(s),t.appendChild(n),t.appendChild(o),this.zoomSlider=i,"static"===getComputedStyle(this.container).position&&(this.container.style.position="relative"),this.container.appendChild(t)}configureDrag(){let t=!1,e=0,i=0;this.svg.addEventListener("mousedown",s=>{0===s.button&&(t=!0,e=s.clientX-this.translationX,i=s.clientY-this.translationY,this.svg.classList.add("arrastrando"))}),window.addEventListener("mousemove",s=>{t&&(s.preventDefault(),this.translationX=s.clientX-e,this.translationY=s.clientY-i,this.updateTransformation())}),window.addEventListener("mouseup",()=>{t=!1,this.svg.classList.remove("arrastrando")}),this.svg.addEventListener("touchstart",s=>{1===s.touches.length&&(s.preventDefault(),t=!0,e=s.touches[0].clientX-this.translationX,i=s.touches[0].clientY-this.translationY,this.svg.classList.add("arrastrando"))}),window.addEventListener("touchmove",s=>{t&&1===s.touches.length&&(s.preventDefault(),this.translationX=s.touches[0].clientX-e,this.translationY=s.touches[0].clientY-i,this.updateTransformation())}),window.addEventListener("touchend",()=>{t=!1,this.svg.classList.remove("arrastrando")}),this.svg.addEventListener("wheel",t=>{t.preventDefault();let e=t.deltaY<0?.1:-.1;this.adjustZoom(e)})}updateTransformation(){this.draggableGroup.setAttribute("transform",`translate(${this.translationX},${this.translationY}) scale(${this.currentScale})`)}adjustZoom(t){let e=Math.max(.5,Math.min(3,this.currentScale+t));this.setZoom(e)}setZoom(t){this.currentScale=t,this.zoomSlider.value=t,this.zoomLabel.textContent=`${Math.round(100*t)}%`,this.updateTransformation()}renderChart(){let t=this.options.nodeHeight+this.options.verticalSpacing;this.adjustSVGSize(),this.renderConnections();for(let e=0;e<this.nodesAtLevel.length;e++){let i=this.nodesAtLevel[e]||[],s=e*t+50;i.forEach(t=>{let i=this.nodePositions[t.id].x;this.renderNode(t,i,s,e)})}}renderConnections(){let t=this.options.nodeHeight+this.options.verticalSpacing,e=new Map,i=(t,s=null)=>{for(let n of t)s&&e.set(n.id,s),n.children&&n.children.length>0&&i(n.children,n)};i(this.hierarchicalData);let s={};for(let n=0;n<this.nodesAtLevel.length;n++){let o=this.nodesAtLevel[n]||[];for(let a of o){let r=e.get(a.id);if(r){let l=this.expandedNodes.get(r.id);l&&(s[r.id]||(s[r.id]=[]),s[r.id].push(a))}}}Object.keys(s).forEach(e=>{let i=s[e];if(!i||!i.length)return;let n=this.nodePositions[e];if(!n)return;let o=n.x,a=n.level,r=this.findNodeById(Number(e));if(!r)return;let l=a*t+50+this.options.avatarSize/2;l+=this.getNameSize(r);let h=i.map(e=>{let i=this.nodePositions[e.id];return i?{node:e,x:i.x,y:i.level*t+50}:null}).filter(t=>null!==t);if(!h.length)return;h.sort((t,e)=>t.x-e.x);let d=Math.min(...h.map(t=>t.y)),c=l+Math.min((d-l)/3,t/2),p=document.createElementNS("http://www.w3.org/2000/svg","line");if(p.setAttribute("class","linea-conexion"),p.setAttribute("x1",o),p.setAttribute("y1",l+2),p.setAttribute("x2",o),p.setAttribute("y2",c),this.draggableGroup.appendChild(p),h.length>1){let g=h[0].x,u=h[h.length-1].x,$=document.createElementNS("http://www.w3.org/2000/svg","line");$.setAttribute("class","linea-conexion"),$.setAttribute("x1",g),$.setAttribute("y1",c),$.setAttribute("x2",u),$.setAttribute("y2",c),this.draggableGroup.appendChild($)}h.forEach(t=>{let e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("class","linea-conexion"),e.setAttribute("d",`M ${t.x} ${c} V ${t.y-this.options.avatarSize/2}`),this.draggableGroup.appendChild(e)})})}getNameSize(t){let e=t.name||"",i=e.split(" ");return i.length<=2?40:60}renderNode(t,e,i,s){let n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("class","nodo-organigrama"),n.setAttribute("data-id",t.id);let o=t.children&&t.children.length>0;n.setAttribute("data-tiene-hijos",o?"true":"false"),o&&n.addEventListener("click",()=>this.toggleNode(t.id));let a=document.createElementNS("http://www.w3.org/2000/svg","circle");if(a.setAttribute("class","avatar"),a.setAttribute("cx",e),a.setAttribute("cy",i),a.setAttribute("r",this.options.avatarSize/2),n.appendChild(a),t.img){let r=document.createElementNS("http://www.w3.org/2000/svg","image");r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",t.img),r.setAttribute("x",e-this.options.avatarSize/2),r.setAttribute("y",i-this.options.avatarSize/2),r.setAttribute("width",this.options.avatarSize),r.setAttribute("height",this.options.avatarSize);let l=`clip-path-${t.id}`,h=document.createElementNS("http://www.w3.org/2000/svg","clipPath");h.setAttribute("id",l);let d=document.createElementNS("http://www.w3.org/2000/svg","circle");d.setAttribute("cx",e),d.setAttribute("cy",i),d.setAttribute("r",this.options.avatarSize/2),h.appendChild(d),this.svg.appendChild(h),r.setAttribute("clip-path",`url(#${l})`),n.appendChild(r),a.setAttribute("fill","transparent")}let c=document.createElementNS("http://www.w3.org/2000/svg","circle");c.setAttribute("class","borde-avatar"),c.setAttribute("cx",e),c.setAttribute("cy",i),c.setAttribute("r",this.options.avatarSize/2),n.appendChild(c);let p=document.createElementNS("http://www.w3.org/2000/svg","text");p.setAttribute("class","nombre"),p.setAttribute("x",e),p.setAttribute("y",i+this.options.avatarSize/2+20);let g=t.name||"",u=g.split(" ");if(u.length<=2)p.textContent=g;else{let $=Math.ceil(u.length/2),v=u.slice(0,$).join(" "),x=u.slice($).join(" "),m=document.createElementNS("http://www.w3.org/2000/svg","tspan");m.setAttribute("x",e),m.setAttribute("dy","0"),m.textContent=v,p.appendChild(m);let w=document.createElementNS("http://www.w3.org/2000/svg","tspan");w.setAttribute("x",e),w.setAttribute("dy","1.2em"),w.textContent=x,p.appendChild(w)}n.appendChild(p);let b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("class","cargo"),b.setAttribute("x",e);let f=i+this.options.avatarSize/2+(u.length<=2?40:60);b.setAttribute("y",f);let S=t.title||"";if(b.textContent=S.charAt(0).toUpperCase()+S.slice(1),n.appendChild(b),this.draggableGroup.appendChild(n),o){let A=e+this.options.avatarSize/2+5;this.addExpandCollapseButton(t,A,i)}}addExpandCollapseButton(t,e,i){let s=this.expandedNodes.get(t.id),n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("class","boton-expandir-colapsar"),n.setAttribute("data-nodo-id",t.id);let o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("class","circulo-boton"),o.setAttribute("cx",e),o.setAttribute("cy",i),o.setAttribute("r",8),o.style.stroke=this.options.nodeColor,o.style.strokeWidth="2";let a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("class","simbolo-boton"),a.setAttribute("x",e),a.setAttribute("y",i+1),a.style.fontSize="14px",a.textContent=s?"-":"+",a.style.fill=this.options.nodeColor,n.appendChild(o),n.appendChild(a),n.addEventListener("click",e=>{e.stopPropagation(),this.toggleNode(t.id)}),this.draggableGroup.appendChild(n)}expandAll(){this.expandedNodes.forEach((t,e)=>{this.expandedNodes.set(e,!0)}),this.calculateDimensions(),this.render()}collapseAll(){let t=(e,i)=>{e.forEach(e=>{this.expandedNodes.set(e.id,i<this.options.initialVisibleLevels),e.children&&e.children.length>0&&t(e.children,i+1)})};t(this.hierarchicalData,0),this.calculateDimensions(),this.render()}findNodeById(t){let e=i=>{for(let s of i){if(s.id==t)return s;if(s.children&&s.children.length>0){let n=e(s.children);if(n)return n}}return null};return e(this.hierarchicalData)}resetLevels(){this.configureInitialExpansion(),this.calculateDimensions(),this.render()}update(t){this.data=t,this.hierarchicalData=null,this.expandedNodes=new Map,this.initialize()}resize(){this.calculateDimensions(),this.render()}assignXPositions(t,e,i){this.nodesAtLevel[i]||(this.nodesAtLevel[i]=[]);let s=t=>{if(0===t.length)return 0;let e=0;for(let i of t)e+=this.options.nodeWidth+this.options.horizontalSpacing;return e-this.options.horizontalSpacing};for(let n=0;n<t.length;n++){let o=t[n];if(this.nodesAtLevel[i].push(o.node),o.children&&o.children.length>0){let a=s(o.children),r=e;this.options.nodeWidth>a&&(r+=(this.options.nodeWidth-a)/2),this.assignXPositions(o.children,r,i+1),e+=o.width+this.options.horizontalSpacing}else this.nodePositions[o.node.id]={x:e+o.width/2,level:i},e+=o.width+this.options.horizontalSpacing}for(let l=0;l<t.length;l++){let h=t[l];if(h.children&&h.children.length>0){let d=h.children.map(t=>t.node.id),c=d.map(t=>this.nodePositions[t]?.x||0);if(c.length>0){let p=Math.min(...c),g=Math.max(...c);this.nodePositions[h.node.id]={x:(p+g)/2,level:i}}else this.nodePositions[h.node.id]={x:e-this.options.horizontalSpacing-this.options.nodeWidth/2+l*(this.options.nodeWidth+this.options.horizontalSpacing),level:i}}else this.nodePositions[h.node.id]={x:e-this.options.horizontalSpacing-this.options.nodeWidth/2+l*(this.options.nodeWidth+this.options.horizontalSpacing),level:i}}}adjustSubtreePositions(t,e){if(t.children&&0!==t.children.length&&this.expandedNodes.get(t.id))for(let i of t.children)this.nodePositions[i.id]&&(this.nodePositions[i.id].x+=e,this.adjustSubtreePositions(i,e))}}"undefined"!=typeof module&&module.exports?module.exports=SimpleOrgChart:window.SimpleOrgChart=SimpleOrgChart;
